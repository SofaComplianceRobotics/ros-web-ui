<!-- Inspired by https://foxglove.dev/blog/using-rosbridge-with-ros2 -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="google" content="notranslate">
    <title>Hello world</title>
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.10.4/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.10.4/dist/cdn/beer.min.js"></script>
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <main class="responsive">
        <div class="row">
            <h3 class="max">Welcome  </h3>
            <button class="circle" onclick="mode()"><i>light_mode</i></button>
        </div>
        <h5>Control Emio Remotely!</h5>
        <div class="field border label">
            <input type="text" id="ip-address" value="127.0.0.1" required pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$" onchange="handleIpChange()">
            <label>IP Address</label>
        </div>
        <p>Connection: <span id="status" style="font-weight: bold;">N/A</span></p>
        <p><code>/TCPTarget/Frame</code> messages received:
        <p id="messages" style="font-family: monospace;margin-left: 1em;;"></p>
        </p>

        <details open>
            <summary>
                <div class="field middle-align">
                    <nav>
                        <i></i>
                        <div class="max">
                            <h6>TCPTarget/Frame</h6>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="checkbox-TCPFrame" onchange="togglePublishing('TCP/Frame')">
                            <span></span>
                        </label>
                    </nav>
                </div>              
            </summary>
            <fieldset>
                <legend>Send to <code>/TCPTarget/Frame</code> topic with the following values:</legend>
                <div class="field middle-align">
                    <label class="slider">
                        <input type="range" value="0" min="-40" max="40" step="0.1" id="x-tcp-frame" oninput="publishTCPFrame()">
                        <span></span>
                        <div class="tooltip"></div>
                    </label>
                    <span class="helper">X</span>
                </div>

                <div class="field middle-align">
                    <label class="slider">
                        <input type="range" value="-150" min="-190" max="-110" step="0.1" id="y-tcp-frame" oninput="publishTCPFrame()">
                        <span></span>
                        <div class="tooltip"></div>
                    </label>
                    <span class="helper">Y</span>
                </div>

                <div class="field middle-align">
                    <label class="slider">
                        <input type="range" value="0" min="-40" max="40" step="0.1" id="z-tcp-frame" oninput="publishTCPFrame()">
                        <span></span>
                        <div class="tooltip"></div>
                    </label>
                    <span class="helper">Z</span>
                </div>
            </fieldset>
        </details>

    </main>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>

    <script type="text/javascript" type="text/javascript">

        // theme mode
        const mode = () => {
            let newMode = ui("mode") == "dark" ? "light" : "dark";
            ui("mode", newMode);
        }

        let ipAddress = document.getElementById("ip-address").value;
        

        // Create ros object to communicate over your Rosbridge connection
        const ros = new ROSLIB.Ros({ url: `ws://${ipAddress}:9090` });

        // When the Rosbridge server connects, fill the span with id "status" with "successful"
        ros.on("connection", () => {
            document.getElementById("status").innerHTML = "successful";
        });

        // When the Rosbridge server experiences an error, fill the "status" span with the returned error
        ros.on("error", (error) => {
            document.getElementById("status").innerHTML = `errored out (${error})`;
        });

        // When the Rosbridge server shuts down, fill the "status" span with "closed"
        ros.on("close", () => {
            document.getElementById("status").innerHTML = "closed";
        });

        // Create a listener for /my_topic
        const my_topic_listener = new ROSLIB.Topic({
            ros,
            name: "/TCPTarget/Frame",
            messageType: "std_msgs/Float32MultiArray",
        });

        // When we receive a message, fill the "messages" span with the data from the message
        my_topic_listener.subscribe((message) => {
            const ul = document.getElementById("messages");
            ul.innerHTML = message.data;
        });

        
        // Create a Publisher
        const my_topic_publisher = new ROSLIB.Topic({
            ros,
            name: "/TCPTarget/Frame",
            messageType: "std_msgs/Float32MultiArray",
        });

        // Function to toggle publishing
        function togglePublishing(topic) {
            const checkbox = document.querySelector(`#checkbox-TCPFrame`);
            if (checkbox.checked) {
                // Start publishing
                console.log(`Started publishing to ${topic}`);
            } else {
                // Stop publishing
                console.log(`Stopped publishing to ${topic}`);
            }
        }

        function publishTCPFrame(){
            const checkbox = document.querySelector(`#checkbox-TCPFrame`);
            if (checkbox.checked) {
                const x = parseFloat(document.getElementById("x-tcp-frame").value);
                const y = parseFloat(document.getElementById("y-tcp-frame").value);
                const z = parseFloat(document.getElementById("z-tcp-frame").value);
                // Start publishing
                my_topic_publisher.publish(new ROSLIB.Message({
                    data: [x, y, z, 0, 0, 0, 1],
                }));
            }
        }

        function handleIpChange() {
            ipAddress = document.getElementById("ip-address").value;
            console.log(`IP Address changed to: ${ipAddress}`);
            ros.close();
            ros.connect(`ws://${ipAddress}:9090`);
        }

    </script>
</body>

</html>